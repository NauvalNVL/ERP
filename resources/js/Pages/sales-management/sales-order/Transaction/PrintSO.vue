<template>
  <AppLayout header="Print SO">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50" v-page-transition>
      <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="text-center mb-8">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-4 shadow-lg">
            <i class="fa-solid fa-print text-white text-2xl"></i>
          </div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
            Print Sales Order
          </h1>
          <p class="text-gray-600 text-lg">Generate and print sales order reports with modern interface</p>
        </div>

        <!-- Main Card -->
        <div class="bg-white/80 backdrop-blur-sm shadow-2xl rounded-2xl overflow-hidden border border-white/20 animate-fade-in-up">
          <!-- Card Header -->
          <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                  <i class="fa-solid fa-print text-white text-lg"></i>
                </div>
            <div>
                  <h2 class="text-xl font-bold text-white">Print Configuration</h2>
                  <p class="text-blue-100 text-sm">Configure your sales order printing parameters</p>
            </div>
          </div>
          <button
            @click="resetForm"
                class="modern-btn-secondary"
          >
                <i class="fa-solid fa-rotate-left mr-2"></i>
                Reset Form
          </button>
            </div>
        </div>

          <!-- Card Content -->
          <div class="p-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Left Column -->
              <div class="space-y-6">
                <!-- Current Period Section -->
                <div class="modern-section">
                  <div class="modern-section-header">
                    <i class="fa-solid fa-calendar-days text-blue-500"></i>
                    <h3 class="modern-section-title">Current Period</h3>
                  </div>
                  <div class="modern-section-content">
                    <div class="flex items-center gap-3">
                      <div class="flex-1">
                        <label class="modern-label">Month</label>
                        <input 
                          v-model.number="form.period.month" 
                          type="number" 
                          min="1" 
                          max="12" 
                          class="modern-input text-center"
                          placeholder="MM"
                        />
                      </div>
                      <div class="flex-1">
                        <label class="modern-label">Year</label>
                        <input 
                          v-model.number="form.period.year" 
                          type="number" 
                          min="2000" 
                          max="2099" 
                          class="modern-input text-center"
                          placeholder="YYYY"
                        />
                      </div>
                    </div>
              </div>
            </div>

                <!-- SO Range Section -->
                <div class="modern-section">
                  <div class="modern-section-header">
                    <i class="fa-solid fa-list-ol text-green-500"></i>
                    <h3 class="modern-section-title">Sales Order Range</h3>
                  </div>
                  <div class="modern-section-content">
                    <div class="space-y-4">
                      <!-- From Range -->
                      <div>
                        <label class="modern-label">From S/Order#</label>
                <div class="flex items-center gap-2">
                          <input v-model.number="form.from.month" type="number" min="1" max="12" class="modern-input w-16 text-center" placeholder="MM" />
                          <span class="text-gray-400">/</span>
                            <input v-model.number="form.from.year" type="number" min="2000" max="2099" class="modern-input w-20 text-center" placeholder="YYYY" />
                            <span class="text-gray-400">/</span>
                            <input v-model="form.from.seq" type="text" class="modern-input w-24" placeholder="Seq" />
                            <button 
                              class="modern-icon-btn" 
                              title="Lookup"
                              @click="openSalesOrderLookup('from')"
                            >
                    <i class="fa-solid fa-magnifying-glass"></i>
                  </button>
                        </div>
                      </div>
                      
                      <!-- To Range -->
                      <div>
                        <label class="modern-label">To S/Order#</label>
                        <div class="flex items-center gap-2">
                          <input v-model.number="form.to.month" type="number" min="1" max="12" class="modern-input w-16 text-center" placeholder="MM" />
                          <span class="text-gray-400">/</span>
                            <input v-model.number="form.to.year" type="number" min="2000" max="2099" class="modern-input w-20 text-center" placeholder="YYYY" />
                            <span class="text-gray-400">/</span>
                            <input v-model="form.to.seq" type="text" class="modern-input w-24" placeholder="Seq" />
                            <button 
                              class="modern-icon-btn" 
                              title="Lookup"
                              @click="openSalesOrderLookup('to')"
                            >
                    <i class="fa-solid fa-magnifying-glass"></i>
                  </button>
                </div>
                      </div>
                </div>
              </div>
            </div>

                <!-- Quick Print Section -->
                <div class="modern-section">
                  <div class="modern-section-header">
                    <i class="fa-solid fa-bolt text-yellow-500"></i>
                    <h3 class="modern-section-title">Quick Print</h3>
                  </div>
                  <div class="modern-section-content">
                    <div class="flex gap-2">
                      <input 
                        v-model="quick.so" 
                        class="modern-input flex-1" 
                        placeholder="Enter SO Number (e.g. SO20250001)" 
                      />
                      <button class="modern-btn-primary" @click="quickPrint">
                        <i class="fa-solid fa-bolt mr-2"></i>Quick Print
                      </button>
            </div>
              </div>
            </div>
          </div>

              <!-- Right Column -->
              <div class="space-y-6">
                <!-- Print Settings Section -->
                <div class="modern-section">
                  <div class="modern-section-header">
                    <i class="fa-solid fa-cog text-purple-500"></i>
                    <h3 class="modern-section-title">Print Settings</h3>
                  </div>
                  <div class="modern-section-content">
                    <div>
                      <label class="modern-label">Number of Copies</label>
                      <select v-model.number="form.copies" class="modern-select">
                        <option v-for="n in 9" :key="n" :value="n">{{ n }} {{ n === 1 ? 'Copy' : 'Copies' }}</option>
                      </select>
                    </div>
          </div>
        </div>

                <!-- Order Status Filter Section -->
                <div class="modern-section">
                  <div class="modern-section-header">
                    <i class="fa-solid fa-filter text-orange-500"></i>
                    <h3 class="modern-section-title">Order Status Filter</h3>
                  </div>
                  <div class="modern-section-content">
                    <div class="grid grid-cols-1 gap-3">
                      <label class="modern-checkbox">
                        <input type="checkbox" v-model="form.status.outstanding" />
                        <span class="checkmark"></span>
                        <span class="label-text">Outstanding</span>
                        <span class="status-badge outstanding">Active</span>
                      </label>
                      <label class="modern-checkbox">
                        <input type="checkbox" v-model="form.status.partial" />
                        <span class="checkmark"></span>
                        <span class="label-text">Partial Completed</span>
                        <span class="status-badge partial">Partial</span>
                      </label>
                      <label class="modern-checkbox">
                        <input type="checkbox" v-model="form.status.closed" />
                        <span class="checkmark"></span>
                        <span class="label-text">Closed</span>
                        <span class="status-badge closed">Closed</span>
                      </label>
                      <label class="modern-checkbox">
                        <input type="checkbox" v-model="form.status.completed" />
                        <span class="checkmark"></span>
                        <span class="label-text">Completed</span>
                        <span class="status-badge completed">Done</span>
                      </label>
                      <label class="modern-checkbox">
                        <input type="checkbox" v-model="form.status.cancelled" />
                        <span class="checkmark"></span>
                        <span class="label-text">Cancelled</span>
                        <span class="status-badge cancelled">Cancelled</span>
                      </label>
            </div>
          </div>
              </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex justify-center">
              <button class="modern-btn-confirm" @click="openPrinter()">
                <i class="fa-solid fa-print mr-2"></i>
                Proceed to Print
              </button>
            </div>
          </div>
          </div>

        <!-- Preview Section -->
        <div v-if="preview" class="mt-8 bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl overflow-hidden border border-white/20">
          <div class="bg-gradient-to-r from-green-500 to-blue-500 px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                  <i class="fa-solid fa-eye text-white"></i>
                </div>
                <div>
                  <h3 class="text-lg font-bold text-white">Preview Report</h3>
                  <p class="text-green-100 text-sm">Review your sales order report before printing</p>
            </div>
          </div>
              <div class="flex gap-2">
                <button class="modern-btn-download" @click="downloadPdf">
                  <i class="fa-solid fa-file-pdf mr-2"></i> PDF
                </button>
                <button class="modern-btn-download" @click="downloadExcel">
                  <i class="fa-solid fa-file-excel mr-2"></i> Excel
            </button>
          </div>
        </div>
      </div>
          <div class="p-6 overflow-auto max-h-96">
            <div class="font-mono text-xs whitespace-pre leading-5 bg-white p-6 rounded-lg border shadow-sm" style="font-family: 'Courier New', monospace;">
              {{ previewText }}
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sales Order Lookup Modal -->
    <SalesOrderLookupModal
      :is-open="salesOrderModal.open"
      :search-params="salesOrderModal.searchParams"
      @close="closeSalesOrderModal"
      @select="onSalesOrderSelect"
      @zoom="onSalesOrderZoom"
    />

    <!-- Printer Modal -->
    <div v-if="printer.open" class="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="printer.open = false"></div>
      <div class="relative bg-white w-full max-w-md rounded-2xl shadow-2xl border border-white/20 animate-fade-in-up">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4 rounded-t-2xl">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
              <i class="fa-solid fa-print text-white"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white">Printer Selection</h3>
              <p class="text-purple-100 text-sm">Configure your printing preferences</p>
            </div>
          </div>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6 space-y-6">
          <div>
            <label class="modern-label">Printer Code</label>
            <input 
              v-model="printer.code" 
              class="modern-input w-full" 
              placeholder="e.g. HPL-001" 
            />
            <p class="text-xs text-gray-500 mt-1">Enter the printer identifier for this print job</p>
          </div>
          <div>
            <label class="modern-label">User ID</label>
            <input 
              v-model="printer.user" 
              class="modern-input w-full bg-gray-100" 
              disabled 
            />
            <p class="text-xs text-gray-500 mt-1">Current user identifier (read-only)</p>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end gap-3">
          <button class="modern-btn-cancel" @click="printer.open = false">
            <i class="fa-solid fa-times mr-2"></i>Cancel
          </button>
          <button class="modern-btn-confirm" @click="proceedPrint">
            <i class="fa-solid fa-check mr-2"></i>Proceed
          </button>
        </div>
      </div>
    </div>
  </AppLayout>
</template>

<script setup>
import { reactive, ref, computed, onMounted } from 'vue'
import axios from 'axios'
import jsPDF from 'jspdf'
import autoTable from 'jspdf-autotable'
import SalesOrderLookupModal from '@/Components/SalesOrderLookupModal.vue'

const now = new Date()
const form = reactive({
  period: { month: now.getMonth() + 1, year: now.getFullYear() },
  from: { month: now.getMonth() + 1, year: now.getFullYear(), seq: '' },
  to: { month: now.getMonth() + 1, year: now.getFullYear(), seq: '' },
  copies: 1,
  status: { outstanding: true, partial: true, closed: true, completed: true, cancelled: false },
})

const printer = reactive({ open: false, code: 'HPL-001', user: 'user2' })
const preview = ref(false)
const previewText = ref('')
const quick = reactive({ so: '' })

// Current user info
const currentUser = ref({
  user_id: '',
  official_name: '',
  username: ''
})

// Fetch current user info on component mount
const fetchCurrentUser = async () => {
  try {
    console.log('Fetching current user...')
    const response = await axios.get('/api/user/current')
    console.log('User API response:', response.data)
    if (response.data.success) {
      currentUser.value = response.data.data
      console.log('Current user loaded:', currentUser.value)
    } else {
      console.warn('Failed to fetch current user:', response.data.message)
      currentUser.value = {
        user_id: 'guest',
        official_name: 'Guest User',
        username: 'guest'
      }
    }
  } catch (error) {
    console.error('Error fetching current user:', error)
    // Fallback to default if user not authenticated
    currentUser.value = {
      user_id: 'guest',
      official_name: 'Guest User',
      username: 'guest'
    }
  }
}

// Call on component mount using Vue lifecycle hook
onMounted(() => {
  fetchCurrentUser()
})

// Sales Order Lookup Modal
const salesOrderModal = reactive({ 
  open: false, 
  type: 'from', // 'from' or 'to'
  searchParams: {} 
})

function resetForm() {
  form.copies = 1
  form.status = { outstanding: true, partial: true, closed: true, completed: true, cancelled: false }
  form.from.seq = ''
  form.to.seq = ''
}

function openPrinter() {
  printer.open = true
}

// Sales Order Lookup functions
function openSalesOrderLookup(type) {
  salesOrderModal.type = type
  salesOrderModal.searchParams = type === 'from' ? form.from : form.to
  salesOrderModal.open = true
}

function onSalesOrderSelect(selectedSo) {
  // Parse SO number format: MM-YYYY-SEQ (e.g., "06-2025-02264")
  const soParts = selectedSo.so_number.split('-')
  
  if (soParts.length === 3) {
    const month = parseInt(soParts[0])
    const year = parseInt(soParts[1])
    const seq = soParts[2]
    
    if (salesOrderModal.type === 'from') {
      form.from.month = month
      form.from.year = year
      form.from.seq = seq
    } else {
      form.to.month = month
      form.to.year = year
      form.to.seq = seq
    }
  } else {
    // Fallback: try to extract from different formats
    console.warn('Unexpected SO number format:', selectedSo.so_number)
    if (salesOrderModal.type === 'from') {
      form.from.seq = selectedSo.so_number
    } else {
      form.to.seq = selectedSo.so_number
    }
  }
  
  closeSalesOrderModal()
}

function onSalesOrderZoom(selectedSo) {
  // Handle zoom functionality if needed
  console.log('Zoom sales order:', selectedSo)
}

function closeSalesOrderModal() {
  salesOrderModal.open = false
}

async function proceedPrint() {
  printer.open = false
  
  try {
    // Compose payload similar to desktop filters
    const payload = {
      period: `${form.period.month} ${form.period.year}`,
      range: {
        from: form.from.seq || formatSO(form.from.month, form.from.year, '00001'),
        to: form.to.seq || formatSO(form.to.month, form.to.year, '99999'),
      },
      copies: form.copies,
      status: Object.keys(form.status).filter(k => form.status[k]),
      printer: { code: printer.code, user: printer.user },
    }

    console.log('Proceed print payload:', payload)

    const res = await fetch('/api/so-report', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'Accept': 'application/json',
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
      },
      body: JSON.stringify(payload),
    })
    
    const json = await res.json()
    console.log('SO report response:', json)
    
    preview.value = true
    previewText.value = await formatPreview(json)
  } catch (error) {
    console.error('Error in proceedPrint:', error)
    preview.value = true
    previewText.value = 'Error generating report: ' + (error.message || error)
  }
}

async function formatPreview(data) {
  const lines = []
  
  // Header Section
  lines.push('PT. MULTIBOX INDAH')
  lines.push('SALES ORDER REPORT')
  lines.push(''.padEnd(80, '-'))
  
  // Report Information
  const fromRange = form.from.seq || formatSO(form.from.month, form.from.year, '00001')
  const toRange = form.to.seq || formatSO(form.to.month, form.to.year, '99999')
  
  lines.push(`Period: ${form.period.month}/${form.period.year}`)
  lines.push(`Range: ${fromRange} to ${toRange}`)
  lines.push(`Status: ${Object.keys(form.status).filter(k => form.status[k]).join(', ').toUpperCase()}`)
  lines.push(`Printer: ${printer.code} | User: ${printer.user}`)
  lines.push('')
  
  // Use data from API response if available, otherwise fetch fresh data
  let salesOrdersData
  if (data && data.success && data.data && data.data.sales_orders) {
    // Use data from API response
    const salesOrders = data.data.sales_orders
    salesOrdersData = [
      ['SO#', 'Customer PO#', 'Customer', 'Status', 'Amount', 'Date']
    ]
    
    if (salesOrders.length > 0) {
      salesOrders.forEach(order => {
        salesOrdersData.push([
          order.SO_Num || '',
          order.PO_Num || '',
          order.AC_NAME || '',
          order.STS || 'OPEN',
          order.AMOUNT ? `Rp ${Number(order.AMOUNT).toLocaleString('id-ID')}` : 'Rp 0',
          order.SO_DMY || order.PO_DATE || ''
        ])
      })
    } else {
      salesOrdersData.push(['No sales orders found for the selected criteria', '', '', '', '', ''])
    }
  } else {
    // Fallback: fetch fresh data
    salesOrdersData = await fetchSalesOrdersData()
  }
  
  // Create table header
  const headerRow = salesOrdersData[0]
  lines.push(headerRow.map((col, index) => {
    const widths = [12, 15, 30, 12, 15, 12] // Column widths
    return String(col).padEnd(widths[index])
  }).join(' | '))
  lines.push(''.padEnd(100, '-'))
  
  // Create table rows
  salesOrdersData.slice(1).forEach(row => {
    lines.push(row.map((col, index) => {
      const widths = [12, 15, 30, 12, 15, 12] // Column widths
      return String(col).padEnd(widths[index])
    }).join(' | '))
  })
  
  lines.push('')
  
  // Summary Section
  const dataRows = salesOrdersData.slice(1)
  const totalOrders = dataRows.length
  
  lines.push('SUMMARY')
  lines.push(`Total Sales Orders: ${totalOrders}`)
  
  if (data && data.data && data.data.summary) {
    const summary = data.data.summary
    lines.push(`Outstanding: ${summary.outstanding || 0}`)
    lines.push(`Partial: ${summary.partial || 0}`)
    lines.push(`Completed: ${summary.completed || 0}`)
    lines.push(`Closed: ${summary.closed || 0}`)
    lines.push(`Cancelled: ${summary.cancelled || 0}`)
  } else {
    lines.push(`Outstanding: ${dataRows.filter(row => row[3] === 'OPEN').length}`)
    lines.push(`Partial: ${dataRows.filter(row => row[3] === 'PARTIAL').length}`)
    lines.push(`Completed: ${dataRows.filter(row => row[3] === 'COMPLETED').length}`)
  }
  
  lines.push('')
  
  // Footer
  lines.push('Generated by ERP System')
  lines.push(`Generated on: ${new Date().toLocaleString()}`)
  
  return lines.join('\n')
}

async function fetchSalesOrdersData() {
  try {
    console.log('Fetching sales orders with params:', {
      month: form.period.month,
      year: form.period.year,
      from_so: formatSO(form.from.month, form.from.year, form.from.seq || '0'),
      to_so: formatSO(form.to.month, form.to.year, form.to.seq || '99999'),
      status: Object.keys(form.status).filter(k => form.status[k])
    })
    
    const response = await axios.get('/api/sales-orders', {
      params: {
        month: form.period.month,
        year: form.period.year,
        from_so: formatSO(form.from.month, form.from.year, form.from.seq || '0'),
        to_so: formatSO(form.to.month, form.to.year, form.to.seq || '99999'),
        status: Object.keys(form.status).filter(k => form.status[k])
      }
    })
    
    console.log('API Response:', response.data)
    
    if (response.data.success) {
      const salesOrders = response.data.data
      console.log('Sales Orders Count:', salesOrders.length)
      
      const tableData = [
        ['SO#', 'Customer PO#', 'Customer', 'Status', 'Amount', 'Date']
      ]
      
      salesOrders.forEach(order => {
        console.log('Processing order:', order)
        tableData.push([
          order.SO_Num || order.so_number || '',
          order.PO_Num || order.customer_po_number || '',
          order.AC_NAME || order.customer_name || '',
          order.STS || order.status || 'Draft',
          `Rp ${(order.AMOUNT || order.total_amount || 0).toLocaleString('id-ID')}`,
          order.SO_DMY || order.po_date || ''
        ])
      })
      
      console.log('Table Data:', tableData)
      return tableData
    } else {
      console.warn('API returned success=false')
      // Fallback to empty data
      return [
        ['SO#', 'Customer PO#', 'Customer', 'Status', 'Amount', 'Date'],
        ['No data available', '', '', '', '', '']
      ]
    }
  } catch (error) {
    console.error('Error fetching sales orders:', error)
    console.error('Error details:', error.response?.data)
    // Fallback to empty data
    return [
      ['SO#', 'Customer PO#', 'Customer', 'Status', 'Amount', 'Date'],
      ['Error loading data: ' + (error.response?.data?.message || error.message), '', '', '', '', '']
    ]
  }
}

async function downloadPdf() {
  try {
    // Ensure current user is loaded first
    if (!currentUser.value.user_id || currentUser.value.user_id === '') {
      console.log('User not loaded yet, fetching...')
      await fetchCurrentUser()
      // Wait a bit to ensure the ref is updated
      await new Promise(resolve => setTimeout(resolve, 100))
    }
    
    console.log('Starting PDF generation with user:', currentUser.value)
    
    const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' })
    
    // Fetch real sales orders data
    const salesOrdersData = await fetchSalesOrdersData()
    
    console.log('Sales Orders Data:', salesOrdersData)
    
    // Check if we have data
    if (!salesOrdersData || salesOrdersData.length <= 1) {
      alert('No sales order data found for the selected period and range.')
      return
    }
    
    let processedCount = 0
    
    // Process each sales order
    for (let i = 1; i < salesOrdersData.length; i++) {
      const orderRow = salesOrdersData[i]
      const soNumber = orderRow[0]
      
      console.log(`Processing SO #${i}:`, soNumber)
      
      if (!soNumber || soNumber === 'No data available' || soNumber === 'Error loading data') {
        console.log('Skipping invalid SO number')
        continue
      }
      
      // Fetch detailed SO data with better error handling
      try {
        console.log(`Fetching details for SO: ${soNumber}`)
        const response = await fetch(`/api/sales-order/${encodeURIComponent(soNumber)}/delivery-schedules`, {
          headers: { 
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        })
        
        // Check if response is ok
        if (!response.ok) {
          console.error(`HTTP Error ${response.status} for SO ${soNumber}`)
          continue
        }
        
        // Get raw text first to check for BOM
        const rawText = await response.text()
        console.log(`Raw response for ${soNumber} (first 100 chars):`, rawText.substring(0, 100))
        
        // Remove BOM if present (BOM is \uFEFF)
        const cleanText = rawText.replace(/^\uFEFF/, '').replace(/^\ufeff/, '').trim()
        
        // Try to parse JSON
        let json
        try {
          json = JSON.parse(cleanText)
        } catch (parseError) {
          console.error(`JSON Parse Error for SO ${soNumber}:`, parseError)
          console.error('Raw text (first 50 chars):', rawText.substring(0, 50).split('').map(c => c.charCodeAt(0).toString(16)).join(' '))
          console.error('Clean text:', cleanText.substring(0, 200))
          // Continue to next SO instead of breaking the entire process
          continue
        }
        
        console.log(`Response for ${soNumber}:`, json)
        
        if (!json.success) {
          console.warn(`Failed to fetch SO ${soNumber}:`, json.message)
          continue
        }
        
        const so = json.data.sales_order
        const schedules = json.data.delivery_schedules || []
        const details = so.details || []
        
        console.log('SO Data:', so)
        console.log('Details:', details)
        console.log('Schedules:', schedules)
        
        // Add new page for each SO (except first)
        if (processedCount > 0) {
          doc.addPage()
        }
        
        // Render SO in format similar to image
        renderSalesOrderPdf(doc, so, details, schedules)
        processedCount++
        
      } catch (error) {
        console.error(`Error fetching SO ${soNumber}:`, error)
        console.error('Error details:', {
          message: error.message,
          stack: error.stack
        })
        // Continue to next SO instead of crashing
      }
    }
    
    if (processedCount === 0) {
      alert('No valid sales orders found to generate PDF.')
      return
    }
    
    console.log(`Processed ${processedCount} sales orders`)
    
    // Save the PDF
    doc.save(`SalesOrder_${form.period.month}_${form.period.year}.pdf`)
  } catch (error) {
    console.error('Error generating PDF:', error)
    alert('Error generating PDF: ' + error.message)
  }
}

function renderSalesOrderPdf(doc, so, details, schedules) {
  const leftMargin = 50
  const rightMargin = 545
  const pageWidth = 595
  let yPos = 60
  
  // Debug: Log current user data
  console.log('renderSalesOrderPdf - currentUser:', currentUser.value)
  
  // Header
  doc.setFont('courier', 'bold')
  doc.setFontSize(9)
  doc.text('PT. MULTIBOX INDAH', leftMargin, yPos)
  doc.text(`S/ORDER# : ${so.so_number || ''}`, rightMargin, yPos, { align: 'right' })
  yPos += 11
  
  doc.text('SALES ORDER', leftMargin, yPos)
  doc.text(`S/O DATE : ${formatDate(so.po_date) || ''}`, rightMargin, yPos, { align: 'right' })
  yPos += 11
  
  // Credit control line
  doc.setFont('courier', 'normal')
  doc.setFontSize(8)
  const creditControl = 'Credit Control: System Approved'
  const creditDate = new Date().toLocaleString('en-GB', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit'
  })
  // Use dynamic user_id instead of hardcoded 'mkt12'
  const userId = currentUser.value.user_id || 'guest'
  console.log('PDF - Using userId:', userId, 'from currentUser:', currentUser.value)
  doc.text(`${creditControl}    , ${creditDate}, ${userId}`, leftMargin, yPos)
  doc.text(`PAGE NO : 1`, rightMargin, yPos, { align: 'right' })
  yPos += 3
  
  // Separator line
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, rightMargin, yPos)
  yPos += 10
  
  // Customer section (left side)
  doc.setFont('courier', 'bold')
  doc.setFontSize(8)
  doc.text('CUSTOMER:', leftMargin, yPos)
  yPos += 10
  
  doc.setFont('courier', 'normal')
  doc.text(so.customer_name || '', leftMargin, yPos)
  
  // Deliver To section (right side)
  doc.setFont('courier', 'bold')
  doc.text('DELIVER TO:', 300, yPos - 10)
  doc.setFont('courier', 'normal')
  
  const deliverTo = so.delivery_location || so.customer_name || ''
  doc.text(deliverTo, 300, yPos)
  yPos += 10
  
  // Address
  const addressLines = (so.customer_address || '').split(',').map(s => s.trim()).filter(Boolean)
  addressLines.forEach((line, idx) => {
    if (idx < 3) {
      doc.text(line, leftMargin, yPos)
      yPos += 9
    }
  })
  
  // Delivery address (right side)
  const deliveryAddressLines = (so.delivery_address || so.customer_address || '').split(',').map(s => s.trim()).filter(Boolean)
  let deliveryYPos = yPos - (addressLines.length * 9)
  deliveryAddressLines.forEach((line, idx) => {
    if (idx < 3) {
      doc.text(line, 300, deliveryYPos)
      deliveryYPos += 9
    }
  })
  
  yPos = Math.max(yPos, deliveryYPos) + 5
  
  // Contact info
  doc.text(`TEL : ${so.customer_tel || ''}`, leftMargin, yPos)
  doc.text(`TEL :`, 300, yPos)
  yPos += 9
  doc.text(`FAX :`, leftMargin, yPos)
  doc.text(`FAX :`, 300, yPos)
  yPos += 9
  doc.text(`EMAIL :`, leftMargin, yPos)
  doc.text(`EMAIL :`, 300, yPos)
  yPos += 10
  
  // Line separator
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, rightMargin, yPos)
  yPos += 10
  
  // Order details
  doc.text(`P/ORDER      : ${so.customer_po_number || ''}`, leftMargin, yPos)
  doc.text(`P/ORDER DATE : ${formatDate(so.po_date) || ''}`, 300, yPos)
  yPos += 9
  doc.text(`ACCOUNT NO   : ${so.customer_code || ''}`, leftMargin, yPos)
  doc.text(`CURRENCY     : ${so.currency || 'IDR'}`, 300, yPos)
  yPos += 9
  doc.text(`M/CARD SEQ# : ${so.master_card_seq || ''}`, leftMargin, yPos)
  doc.text(`PAYMENT TERM : ${so.credit_terms || '30 DAYS'}`, 300, yPos)
  yPos += 9
  doc.text(`MODEL        : ${so.master_card_model || ''}`, leftMargin, yPos)
  doc.text(`PRINT. BLOCK#: 62`, 300, yPos)
  yPos += 10
  
  // Line separator
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, rightMargin, yPos)
  yPos += 9
  
  // Table header - Adjusted to match data positions exactly
  doc.setFont('courier', 'bold')
  doc.setFontSize(7)
  doc.text('TYPE', leftMargin, yPos)
  doc.text('DESCRIPTION', leftMargin + 35, yPos)
  doc.text('QTY', leftMargin + 315, yPos)         // Align above QTY data
  doc.text('UOM', leftMargin + 360, yPos)         // Align above UOM data  
  doc.text('PRICE', leftMargin + 385, yPos)       // Shortened label, align above price data
  doc.text('AMOUNT', rightMargin - 50, yPos)      // Align above amount data
  yPos += 3
  
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, rightMargin, yPos)
  yPos += 9
  
  // Detail rows
  doc.setFont('courier', 'normal')
  doc.setFontSize(7)
  details.forEach((detail) => {
    const qty = detail.order_quantity || 0
    const price = detail.unit_price || 0
    const amount = qty * price
    
    // Main line
    doc.text('Main', leftMargin, yPos)
    
    // Part number and design info - Moved closer to TYPE column
    const partNo = so.part_number || ''
    const pDesign = detail.item_code || ''
    doc.text(`PART NO      : ${partNo}`, leftMargin + 35, yPos)
    yPos += 8
    doc.text(`P/DESIGN     : ${pDesign} ( PCS/SET )`, leftMargin + 35, yPos)
    yPos += 8
    
    // Flute and paper quality
    const flute = detail.flute || ''
    const pq1 = detail.paper_quality_1 || ''
    const pq2 = detail.paper_quality_2 || ''
    const pq3 = detail.paper_quality_3 || ''
    doc.text(`B/QUALITY    : ${pq1}125  /${pq2}125  /${pq3}125  /`, leftMargin + 35, yPos)
    yPos += 8
    
    // Measurement
    const dims = detail.dimensions || {}
    const measurement = `${dims.int_l || 460} L x  ${dims.int_w || 270} W x  ${dims.int_h || 260} H    (Int)`
    doc.text(`MEASUREMENT  : ${measurement}`, leftMargin + 35, yPos)
    yPos += 8
    
    // Roll size
    const rollSize = detail.roll_size || '220 cm'
    doc.text(`ROLL SIZE    : ${rollSize}`, leftMargin + 35, yPos)
    
    // Quantity, UOM, Price, Amount - MAXIMUM spacing to avoid overlap completely
    const qtyText = qty.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
    // Use 0 decimals for price to make it shorter and prevent overlap
    const priceText = price.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
    const amountText = amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
    
    // Positions: QTY(340→390), UOM(360), PRICE(410→max415), AMOUNT(480→540) = 65px gap!
    doc.text(qtyText, leftMargin + 340, yPos - 24, { align: 'right' })      // QTY right-aligned
    doc.text(detail.uom || 'PCS', leftMargin + 360, yPos - 24)              // UOM left-aligned
    doc.text(priceText, leftMargin + 410, yPos - 24, { align: 'right' })    // PRICE: max width ~50px
    doc.text(amountText, rightMargin - 5, yPos - 24, { align: 'right' })    // AMOUNT: 65px+ gap!
    
    yPos += 12
    
    // Additional details
    const grossKg = detail.gross_kg || 0
    const pricePerM2 = detail.price_per_m2 || 0
    doc.text(`Sales Order KG       :  ${grossKg.toFixed(3)}`, leftMargin + 35, yPos)
    yPos += 8
    doc.text(`Price Per M2         :  ${pricePerM2.toFixed(3)}`, leftMargin + 35, yPos)
    yPos += 8
    doc.text(`Exclusive PPn 10%`, leftMargin + 35, yPos)
    yPos += 12
  })
  
  // Delivery schedule
  doc.setFont('courier', 'bold')
  doc.setFontSize(7)
  doc.text('DELIVERY SCHEDULE :', leftMargin, yPos)
  yPos += 9
  
  doc.text('DATE', leftMargin, yPos)
  doc.text('MAIN', leftMargin + 85, yPos)
  doc.text('F1', leftMargin + 120, yPos)
  doc.text('F2', leftMargin + 145, yPos)
  doc.text('F3', leftMargin + 170, yPos)
  doc.text('F4', leftMargin + 195, yPos)
  doc.text('F5', leftMargin + 220, yPos)
  doc.text('F6', leftMargin + 245, yPos)
  doc.text('F7', leftMargin + 270, yPos)
  doc.text('F8', leftMargin + 295, yPos)
  doc.text('F9', leftMargin + 320, yPos)
  doc.text('REMARKS', leftMargin + 345, yPos)
  yPos += 9
  
  doc.setFont('courier', 'normal')
  doc.setFontSize(7)
  schedules.forEach((schedule) => {
    const dateStr = formatDate(schedule.schedule_date)
    const qty = schedule.delivery_quantity || 0
    const qtyText = qty.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
    
    doc.text(dateStr, leftMargin, yPos)
    doc.text(qtyText, leftMargin + 110, yPos, { align: 'right' })
    doc.text(schedule.remark || '', leftMargin + 345, yPos)
    yPos += 8
  })
  
  yPos += 9
  
  // SO Remark
  doc.setFont('courier', 'bold')
  doc.setFontSize(7)
  doc.text('SO Remark :', leftMargin, yPos)
  doc.setFont('courier', 'normal')
  doc.text(so.remark || '', leftMargin + 65, yPos)
  yPos += 12
  
  // Order instructions
  doc.setFont('courier', 'bold')
  doc.text('ORDER INSTRUCTION :', leftMargin, yPos)
  yPos += 9
  doc.setFont('courier', 'normal')
  doc.text(`1. ${so.instruction1 || 'TOL +10%'}`, leftMargin, yPos)
  yPos += 8
  doc.text(`2. ${so.instruction2 || 'OO'}`, leftMargin, yPos)
  yPos += 15
  
  // Footer signatures
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, rightMargin, yPos)
  yPos += 12
  
  doc.setFont('courier', 'bold')
  doc.setFontSize(7)
  doc.text('CHECKED BY : .', leftMargin, yPos)
  doc.text('APPROVED BY : .', 300, yPos)
  yPos += 25
  
  doc.setLineWidth(0.5)
  doc.line(leftMargin, yPos, leftMargin + 150, yPos)
  doc.line(300, yPos, 450, yPos)
  yPos += 12
  
  // Print info
  doc.setFont('courier', 'normal')
  doc.setFontSize(7)
  const issuedBy = currentUser.value.official_name || 'Unknown User'
  const issuedDate = new Date().toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
  const printedBy = currentUser.value.user_id || 'guest'
  console.log('PDF Footer - issuedBy:', issuedBy, 'printedBy:', printedBy)
  doc.text(`ISSUED BY : ${issuedBy}      ${issuedDate}`, leftMargin, yPos)
  yPos += 8
  doc.text(`PRINTED BY: ${printedBy}      ${issuedDate}`, leftMargin, yPos)
  yPos += 8
  doc.text(`Dok. No : MBI-FM-MKT-015   Rev : 00`, leftMargin, yPos)
  
  doc.text('*** End of Page ***', rightMargin, yPos, { align: 'right' })
}

async function downloadExcel() {
  try {
    // Fetch real sales orders data
    const salesOrdersData = await fetchSalesOrdersData()
    
    // Convert to CSV format
    const csvContent = salesOrdersData.map(row => 
      row.map(cell => `"${cell}"`).join(',')
    ).join('\r\n')
    
    // Add header information
    const fromRange = form.from.seq || formatSO(form.from.month, form.from.year, '00001')
    const toRange = form.to.seq || formatSO(form.to.month, form.to.year, '99999')
    
    const headerInfo = [
      'PT. MULTIBOX INDAH',
      'SALES ORDER REPORT',
      '',
      `Period: ${form.period.month}/${form.period.year}`,
      `Range: ${fromRange} to ${toRange}`,
      `Status: ${Object.keys(form.status).filter(k => form.status[k]).join(', ').toUpperCase()}`,
      `Printer: ${printer.code} | User: ${printer.user}`,
      '',
      csvContent
    ].join('\r\n')
    
    const blob = new Blob([headerInfo], { type: 'text/csv;charset=utf-8;' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
    a.download = `SalesOrder_${form.period.month}_${form.period.year}.csv`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  } catch (error) {
    console.error('Error downloading Excel:', error)
    alert('Error downloading Excel file')
  }
}

function formatSO(m, y, s) {
  const mm = String(m).padStart(2, '0')
  const yyyy = String(y)
  const seq = String(s).padStart(5, '0')
  return `${mm}-${yyyy}-${seq}`
}

function formatDate(dateStr) {
  if (!dateStr) return ''
  const date = new Date(dateStr)
  if (isNaN(date.getTime())) return dateStr
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })
}

// Quick print by SO number, using data created from PrepareMCSO
async function quickPrint() {
  if (!quick.so) return
  try {
    // Ensure current user is loaded first
    if (!currentUser.value.user_id || currentUser.value.user_id === '') {
      console.log('quickPrint: User not loaded yet, fetching...')
      await fetchCurrentUser()
      // Wait a bit to ensure the ref is updated
      await new Promise(resolve => setTimeout(resolve, 100))
    }
    
    console.log('quickPrint: Starting with user:', currentUser.value)
    
    const res = await fetch(`/api/sales-order/${encodeURIComponent(quick.so)}/delivery-schedules`, {
      headers: { Accept: 'application/json' },
    })
    const json = await res.json()
    if (!json.success) {
      preview.value = true
      previewText.value = `Sales Order ${quick.so} not found.`
      return
    }
    const so = json.data.sales_order
    const details = so.details || []
    const schedules = json.data.delivery_schedules || []
    preview.value = true
    previewText.value = renderSoReport(so, details, schedules)
    
    // Also generate PDF for quick print
    const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' })
    renderSalesOrderPdf(doc, so, details, schedules)
    doc.save(`SalesOrder_${quick.so}.pdf`)
  } catch (e) {
    preview.value = true
    previewText.value = `Error fetching SO ${quick.so}: ${e?.message || e}`
  }
}

function renderSoReport(so, details, schedules) {
  const lines = []
  const pad = (t, n) => String(t ?? '').padEnd(n)
  const padL = (t, n) => String(t ?? '').padStart(n)
  const num = (v, decimals = 2) => {
    if (v == null) return ''
    return Number(v).toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals })
  }

  // Header
  lines.push(pad('PT. MULTIBOX INDAH', 60) + `S/ORDER# : ${so.so_number || ''}`)
  lines.push(pad('SALES ORDER', 60) + `S/O DATE : ${formatDate(so.po_date) || ''}`)
  
  const creditDate = new Date().toLocaleString('en-GB', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit'
  })
  const userId = currentUser.value.user_id || 'guest'
  console.log('Text Report - Using userId:', userId, 'from currentUser:', currentUser.value)
  lines.push(`Credit Control: System Approved    , ${creditDate}, ${userId}` + padL('PAGE NO : 1', 20))
  lines.push('-'.repeat(100))
  
  // Customer section
  lines.push('CUSTOMER:' + pad('', 51) + 'DELIVER TO:')
  lines.push(pad(so.customer_name || '', 60) + (so.delivery_location || so.customer_name || ''))
  
  const addressLines = (so.customer_address || '').split(',').map(s => s.trim())
  const deliveryLines = (so.delivery_address || so.customer_address || '').split(',').map(s => s.trim())
  const maxLines = Math.max(addressLines.length, deliveryLines.length)
  
  for (let i = 0; i < maxLines && i < 3; i++) {
    lines.push(pad(addressLines[i] || '', 60) + (deliveryLines[i] || ''))
  }
  
  lines.push('')
  lines.push(`TEL :` + pad('', 55) + 'TEL :')
  lines.push(`FAX :` + pad('', 55) + 'FAX :')
  lines.push(`EMAIL :` + pad('', 53) + 'EMAIL :')
  lines.push('-'.repeat(100))
  
  // Order info
  lines.push(`P/ORDER      : ${pad(so.customer_po_number || '', 40)}P/ORDER DATE : ${formatDate(so.po_date) || ''}`)
  lines.push(`ACCOUNT NO   : ${pad(so.customer_code || '', 40)}CURRENCY     : ${so.currency || 'IDR'}`)
  lines.push(`M/CARD SEQ# : ${pad(so.master_card_seq || '', 41)}PAYMENT TERM : ${so.credit_terms || '30 DAYS'}`)
  lines.push(`MODEL        : ${pad(so.master_card_model || '', 40)}PRINT. BLOCK#: 62`)
  lines.push('-'.repeat(100))
  
  // Table header
  lines.push(pad('TYPE', 15) + pad('DESCRIPTION', 35) + pad('QUANTITY', 12) + pad('UOM', 8) + pad('UNIT PRICE', 14) + 'AMOUNT')
  lines.push('-'.repeat(100))
  
  // Details
  details.forEach((detail) => {
    const qty = detail.order_quantity || 0
    const price = detail.unit_price || 0
    const amount = qty * price
    
    lines.push(pad('Main', 15) + pad(`PART NO      : ${so.part_number || ''}`, 35) + padL(num(qty, 0), 12) + pad(detail.uom || 'PCS', 8) + padL(num(price, 4), 14) + padL(num(amount, 2), 15))
    lines.push(pad('', 15) + `P/DESIGN     : ${detail.item_code || ''} ( PCS/SET )`)
    
    const flute = detail.flute || ''
    const pq1 = detail.paper_quality_1 || ''
    const pq2 = detail.paper_quality_2 || ''
    const pq3 = detail.paper_quality_3 || ''
    lines.push(pad('', 15) + `B/QUALITY    : ${pq1}125  /${pq2}125  /${pq3}125  /                      BF`)
    
    const dims = detail.dimensions || {}
    const measurement = `${dims.int_l || 460} L x  ${dims.int_w || 270} W x  ${dims.int_h || 260} H    (Int)`
    lines.push(pad('', 15) + `MEASUREMENT  : ${measurement}`)
    lines.push(pad('', 15) + `ROLL SIZE    : ${detail.roll_size || '220 cm'}`)
    lines.push('')
    lines.push(pad('', 15) + `Sales Order KG       :  ${num(detail.gross_kg || 0, 3)}`)
    lines.push(pad('', 15) + `Price Per M2         :  ${num(detail.price_per_m2 || 0, 3)}`)
    lines.push(pad('', 15) + `Exclusive PPn 10%`)
  })
  
  lines.push('')
  
  // Delivery schedule
  lines.push('DELIVERY SCHEDULE :')
  lines.push(pad('DATE', 14) + pad('MAIN', 10) + pad('F1', 6) + pad('F2', 6) + pad('F3', 6) + pad('F4', 6) + pad('F5', 6) + pad('F6', 6) + pad('F7', 6) + pad('F8', 6) + pad('F9', 6) + 'REMARKS')
  
  schedules.forEach((s) => {
    const dateStr = formatDate(s.schedule_date)
    const qtyText = padL(num(s.delivery_quantity || 0, 0), 8)
    lines.push(pad(dateStr, 14) + pad(qtyText, 10) + (s.remark || ''))
  })
  
  lines.push('')
  lines.push('SO Remark : ' + (so.remark || ''))
  lines.push('')
  lines.push('ORDER INSTRUCTION :')
  lines.push(`1. ${so.instruction1 || 'TOL +10%'}`)
  lines.push(`2. ${so.instruction2 || 'OO'}`)
  lines.push('')
  lines.push('-'.repeat(100))
  lines.push('CHECKED BY : .' + pad('', 40) + 'APPROVED BY : .')
  lines.push('')
  lines.push('_________________________' + pad('', 30) + '_________________________')
  lines.push('')
  
  const issuedDate = new Date().toLocaleString('en-GB', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit'
  })
  const issuedBy = currentUser.value.official_name || 'Unknown User'
  const printedBy = currentUser.value.user_id || 'guest'
  lines.push(`ISSUED BY : ${issuedBy}      ${issuedDate}`)
  lines.push(`PRINTED BY: ${printedBy}      ${issuedDate}`)
  lines.push(`Dok. No : MBI-FM-MKT-015   Rev : 00` + pad('', 30) + '*** End of Page ***')
  
  return lines.join('\n')
}
</script>

<style scoped>
/* Modern Input Styles */
.modern-input {
  @apply w-full px-4 py-3 border border-gray-200 rounded-xl text-sm transition-all duration-200 
         focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
         hover:border-gray-300 bg-white/80 backdrop-blur-sm;
}

.modern-select {
  @apply w-full px-4 py-3 border border-gray-200 rounded-xl text-sm transition-all duration-200 
         focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
         hover:border-gray-300 bg-white/80 backdrop-blur-sm cursor-pointer;
}

.modern-label {
  @apply block text-sm font-semibold text-gray-700 mb-2;
}

/* Modern Section Styles */
.modern-section {
  @apply bg-white/60 backdrop-blur-sm rounded-xl border border-white/40 shadow-lg overflow-hidden;
}

.modern-section-header {
  @apply flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100;
}

.modern-section-title {
  @apply text-lg font-bold text-gray-800;
}

.modern-section-content {
  @apply p-4;
}

/* Modern Button Styles */
.modern-btn-primary {
  @apply inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white 
         font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 
         transition-all duration-200 hover:from-blue-600 hover:to-blue-700;
}

.modern-btn-secondary {
  @apply inline-flex items-center px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white 
         font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 
         transition-all duration-200 hover:from-gray-600 hover:to-gray-700;
}

.modern-btn-confirm {
  @apply inline-flex items-center px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white 
         font-bold rounded-xl shadow-xl hover:shadow-2xl transform hover:scale-105 
         transition-all duration-200 hover:from-green-600 hover:to-emerald-700;
}

.modern-btn-cancel {
  @apply inline-flex items-center px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white 
         font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 
         transition-all duration-200 hover:from-red-600 hover:to-red-700;
}

.modern-btn-download {
  @apply inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white 
         font-semibold rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 
         transition-all duration-200 hover:from-purple-600 hover:to-pink-600;
}

.modern-icon-btn {
  @apply inline-flex items-center justify-center w-10 h-10 rounded-xl border border-gray-200 
         text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 
         transition-all duration-200 shadow-sm hover:shadow-md;
}

/* Modern Checkbox Styles */
.modern-checkbox {
  @apply flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 
         cursor-pointer transition-all duration-200 hover:shadow-sm;
}

.modern-checkbox input[type="checkbox"] {
  @apply sr-only;
}

.checkmark {
  @apply w-5 h-5 border-2 border-gray-300 rounded-md flex items-center justify-center 
         transition-all duration-200;
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark {
  @apply bg-blue-500 border-blue-500;
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark::after {
  content: '✓';
  @apply text-white text-xs font-bold;
}

.label-text {
  @apply flex-1 text-sm font-medium text-gray-700;
}

/* Status Badge Styles */
.status-badge {
  @apply px-2 py-1 rounded-full text-xs font-semibold;
}

.status-badge.outstanding {
  @apply bg-green-100 text-green-800;
}

.status-badge.partial {
  @apply bg-yellow-100 text-yellow-800;
}

.status-badge.closed {
  @apply bg-gray-100 text-gray-800;
}

.status-badge.completed {
  @apply bg-blue-100 text-blue-800;
}

.status-badge.cancelled {
  @apply bg-red-100 text-red-800;
}

/* Animation */
@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-up {
  animation: fade-in-up 0.5s ease-out;
}

/* Legacy styles for compatibility */
.input {
  @apply modern-input;
}
.label { @apply modern-label; }
.status { @apply modern-checkbox; }
.btn { @apply modern-btn-primary; }
.btn-outline { @apply modern-btn-cancel; }
.btn-secondary { @apply modern-btn-secondary; }
.form-row { @apply grid grid-cols-12 items-center gap-3; }
.form-label { @apply col-span-4 sm:col-span-3 text-sm text-gray-700; }
.icon-btn { @apply modern-icon-btn; }
</style>
