# Sales Order Items Screen - CPS Compatible Enhancements

## üìã Overview
Perbaikan Sales Order Items Screen pada menu "Prepare Invoice by D/Order (Current Period)" agar fetch data real dari database dan display seperti CPS ERP.

---

## ‚úÖ Perubahan yang Telah Dilakukan

### 1. **Enhanced API Controller Method**

**File:** `InvoiceController.php`
**Method:** `getDoItems($request)`

#### **New Features:**
- ‚úÖ Fetch complete DO data from database
- ‚úÖ Calculate totals automatically
- ‚úÖ Build S/O List with unique SO numbers
- ‚úÖ Build Item Details (Main + F#1-F#9)
- ‚úÖ Return comprehensive response

#### **Data Retrieved from DO Table:**
```php
$doRecords = DB::table('DO')
    ->where('DO_Num', $doNumber)
    ->select([
        'DO_Num', 'DO_DMY', 'AC_Num', 'AC_Name',
        'SO_Num', 'MCS_Num', 'Model', 'Product',
        'PD', 'No', 'Unit', 'PCS_PER_SET',
        'DO_Qty', 'SO_Unit_Price', 'DO_Tran_Amt',
        'DO_Base_Amt', 'Curr', 'COMP',
        'Total_DO_Net_KG', 'DO_Remark1', 'DO_Remark2',
    ])
    ->get();
```

#### **Response Structure:**
```json
{
  "do_number": "2025-10-00001",
  "do_date": "29/10/2025",
  "customer_code": "000211-08",
  "customer_name": "ABDULLAH, BPK",
  "so_number": "10-2025-02848",
  "mc_seq": "03-2025-02090",
  "model": "SHIPPING CASE ACOSTA JUMBO",
  "currency": "IDR",
  "control_set_order": 0,
  "s_o_count": 1,
  "total_amount": 4410000,
  "total_qty": 300,
  "so_list": [
    {
      "so_number": "10-2025-02848",
      "mc_seq": "03-2025-02090",
      "do_ref": "2025-10-00001",
      "amount": 4410000
    }
  ],
  "item_details": [
    {
      "item": "Main",
      "p_design": "B1",
      "pcs": 1,
      "unit": "Pcs",
      "u_price": 14700.0000,
      "deliver": 300,
      "reject": 0,
      "unbill": 300,
      "to_bill": 300,
      "to_bill_kg": 0
    },
    {
      "item": "F# 1",
      "p_design": "-",
      "pcs": null,
      // ... all null for finishing items
    }
  ],
  "remarks": {
    "remark1": "test",
    "remark2": "test"
  }
}
```

---

### 2. **Updated Vue Component**

**File:** `SalesOrderItemsModal.vue`

#### **A. Added State Management**
```javascript
const loading = ref(false)
const doData = ref(null)
const soList = ref([])
const itemDetails = ref([])
const controlSetOrder = ref(0)
const soCount = ref(1)
const total = ref(0)
```

#### **B. Fetch Function**
```javascript
const fetchDoItems = async () => {
  loading.value = true
  const response = await fetch(
    `/api/invoices/do-items?do_number=${props.doNumber}`
  )
  
  if (response.ok) {
    const data = await response.json()
    doData.value = data
    soList.value = data.so_list || []
    itemDetails.value = data.item_details || []
    // ... populate other fields
  }
}
```

#### **C. Watchers for Auto-Fetch**
```javascript
// Watch modal open
watch(() => props.open, (isOpen) => {
  if (isOpen && props.doNumber) {
    fetchDoItems()
  }
})

// Watch DO number changes
watch(() => props.doNumber, (newDoNumber) => {
  if (props.open && newDoNumber) {
    fetchDoItems()
  }
})
```

---

### 3. **Template Updates**

#### **A. Loading Indicator**
```vue
<div v-if="loading" class="text-center py-8">
  <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
  <p class="mt-2 text-sm text-gray-600">Loading DO items...</p>
</div>
```

#### **B. S/O List Table (CPS-Compatible)**
```vue
<table>
  <thead>
    <tr>
      <th>No</th>
      <th>S/O Item#</th>
      <th>M/Card Seq#</th>
      <th>D/Order Ref.#</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="(item, index) in soList">
      <td>{{ 1001 + index }}</td>
      <td>{{ item.so_number }}</td>
      <td>{{ item.mc_seq }}</td>
      <td>{{ item.do_ref }}</td>
      <td>{{ formatCurrency(item.amount) }}</td>
    </tr>
  </tbody>
</table>
```

#### **C. Item Details Table**
```vue
<table>
  <thead>
    <tr>
      <th>Item</th>
      <th>P/Design</th>
      <th>Pcs</th>
      <th>Unit</th>
      <th>U/Price</th>
      <th>Deliver</th>
      <th>Reject</th>
      <th>Unbill</th>  <!-- Fixed from "UsBill" -->
      <th>To Bill</th>
      <th>To Bill KG</th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="item in itemDetails">
      <td>{{ item.item }}</td>
      <td>{{ item.p_design }}</td>
      <td>{{ formatNumber(item.pcs) }}</td>
      <!-- ... all fields from API -->
    </tr>
  </tbody>
</table>
```

---

## üîÑ Data Flow

```
User opens Sales Order Items Modal
         ‚Üì
Vue Component mounted
         ‚Üì
Watch triggers: props.open === true
         ‚Üì
fetchDoItems() called
         ‚Üì
API Call: GET /api/invoices/do-items?do_number=2025-10-00001
         ‚Üì
InvoiceController::getDoItems()
         ‚Üì
Query DO table
  ‚Ä¢ Get all DO records with DO_Num
  ‚Ä¢ Calculate totals
  ‚Ä¢ Group by SO_Num for S/O List
  ‚Ä¢ Build item details (Main + F#1-F#9)
         ‚Üì
Return JSON response
         ‚Üì
Vue component receives data
         ‚Üì
Populate state variables:
  ‚Ä¢ soList
  ‚Ä¢ itemDetails
  ‚Ä¢ total
  ‚Ä¢ soCount
         ‚Üì
Template re-renders with real data
         ‚Üì
User sees CPS-compatible display
```

---

## üìä Comparison: Before vs After

### **S/O List Table**

**Before:**
- ‚ùå Hardcoded single row
- ‚ùå Static data (1001, props values)
- ‚ùå No real SO lookup

**After:**
- ‚úÖ Dynamic rows from `soList`
- ‚úÖ Real data from DO table
- ‚úÖ Unique SO numbers grouped
- ‚úÖ Correct amounts calculated

### **Item Details Table**

**Before:**
- ‚ùå Hardcoded "Main" row
- ‚ùå Hardcoded "Fit1-Fit8" rows
- ‚ùå Static values (B1, 1, Pcs, 300)
- ‚ùå Wrong column name "UsBill"

**After:**
- ‚úÖ Dynamic rows from `itemDetails`
- ‚úÖ Real data from DO table
- ‚úÖ "Main" + "F# 1" through "F# 9"
- ‚úÖ Correct column name "Unbill"
- ‚úÖ Real quantities and prices
- ‚úÖ Proper formatting (currency, numbers)

### **Header Info**

**Before:**
- ‚ùå Only from props
- ‚ùå Control Set Order hardcoded to 0

**After:**
- ‚úÖ From API response (doData)
- ‚úÖ Fallback to props if API fails
- ‚úÖ Control Set Order from data

### **Totals**

**Before:**
- ‚ùå From props.totalAmount
- ‚ùå Static S/O Count = 1

**After:**
- ‚úÖ Calculated from DO records
- ‚úÖ Dynamic S/O Count from data
- ‚úÖ Auto-sum of all amounts

---

## üéØ Field Mapping

### **From DO Table to Display:**

| DO Table Field | Display Location | Description |
|----------------|------------------|-------------|
| `DO_Num` | Header: D/Order# | Delivery Order number |
| `DO_DMY` | Header: D/O Date | Date in DD/MM/YYYY |
| `AC_Num` | API only | Customer code |
| `AC_Name` | API only | Customer name |
| `SO_Num` | S/O List: S/O Item# | Sales Order number |
| `MCS_Num` | S/O List: M/Card Seq# | Master Card Sequence |
| `Model` | Model field | Product model name |
| `PD` | Item Details: P/Design | Product Design (e.g., B1) |
| `PCS_PER_SET` | Item Details: Pcs | Pieces per set |
| `Unit` | Item Details: Unit | Unit of measure |
| `SO_Unit_Price` | Item Details: U/Price | Unit price |
| `DO_Qty` | Item Details: Deliver, Unbill, To Bill | Quantity delivered |
| `DO_Tran_Amt` | S/O List: Amount, Total | Transaction amount |
| `Total_DO_Net_KG` | Item Details: To Bill KG | Weight in KG |
| `DO_Remark1` | API: remarks | Remark 1 |
| `DO_Remark2` | API: remarks | Remark 2 |

---

## üöÄ Usage

### **For Users:**

1. **Navigate to:** Prepare Invoice by D/Order (Current Period)
2. **Select a D/O** from Delivery Order Table
3. **Sales Order Items Screen opens**
4. **Automatic Data Load:**
   - ‚úÖ S/O List populated from database
   - ‚úÖ Item details populated from database
   - ‚úÖ Totals calculated automatically
5. **Review data** and click OK to proceed

### **For Developers:**

**Test API Endpoint:**
```bash
curl "http://localhost/api/invoices/do-items?do_number=2025-10-00001"
```

**Expected Response:**
```json
{
  "do_number": "2025-10-00001",
  "do_date": "29/10/2025",
  "s_o_count": 1,
  "total_amount": 4410000,
  "so_list": [...],
  "item_details": [...]
}
```

**Check Laravel Logs:**
```bash
tail -f storage/logs/laravel.log | grep "DO Items"
```

---

## üîß Technical Details

### **No Migration Required**
- ‚úÖ Uses existing DO table
- ‚úÖ No new database columns
- ‚úÖ All data from current structure

### **API Route** (Already Exists)
```php
Route::prefix('invoices')->group(function () {
    Route::get('/do-items', [InvoiceController::class, 'getDoItems']);
});
```
**Endpoint:** `GET /api/invoices/do-items?do_number={DO_NUM}`

### **Error Handling**
```php
// Controller
if ($doRecords->isEmpty()) {
    return response()->json(['error' => 'DO not found'], 404);
}

// Vue Component
catch (error) {
    console.error('‚ùå Error fetching DO items:', error)
}
```

### **Style Preservation**
- ‚úÖ No visual changes
- ‚úÖ Same colors (blue header, yellow highlight)
- ‚úÖ Same fonts and spacing
- ‚úÖ Same table structure
- ‚úÖ Only functional improvements

---

## üìù Features Implemented

### **‚úÖ Completed:**
1. API method `getDoItems()` enhanced
2. Real data fetch from DO table
3. S/O List table with dynamic rows
4. Item Details table with real data
5. Loading indicator during fetch
6. Auto-fetch on modal open
7. Error handling
8. Proper formatting (currency, numbers)
9. Fixed column name "Unbill"
10. Calculate totals from database

### **üé® Visual Features:**
- Loading spinner during data fetch
- Yellow highlight on first S/O row (CPS style)
- Gray background on F# rows
- Proper number formatting
- Responsive table layout

---

## üß™ Testing Checklist

- [x] Modal opens without errors
- [x] Loading indicator shows
- [x] API call successful
- [x] S/O List populated
- [x] Item Details populated
- [x] Totals calculated correctly
- [x] Column name is "Unbill" (not "UsBill")
- [x] Main item shows real data
- [x] F# 1-9 items show as placeholders
- [x] Currency formatted correctly
- [x] Numbers formatted correctly
- [x] No console errors
- [x] No style changes
- [x] CPS-compatible layout

---

## üìä Example Data Display

### **S/O List Table:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ No   ‚îÇ S/O Item#      ‚îÇ M/Card Seq#   ‚îÇ D/Order Ref.#   ‚îÇ Amount      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1001 ‚îÇ 10-2025-02848  ‚îÇ 03-2025-02090 ‚îÇ 2025-10-00001   ‚îÇ 4,410,000   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Item Details Table:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Item ‚îÇ P/Design ‚îÇ Pcs ‚îÇ Unit ‚îÇ U/Price    ‚îÇ Deliver ‚îÇ Reject ‚îÇ Unbill ‚îÇ To Bill ‚îÇ To Bill KG ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Main ‚îÇ B1       ‚îÇ 1   ‚îÇ Pcs  ‚îÇ 14,700,000 ‚îÇ 300     ‚îÇ 0      ‚îÇ 300    ‚îÇ 300     ‚îÇ 0.00       ‚îÇ
‚îÇ F# 1 ‚îÇ -        ‚îÇ -   ‚îÇ -    ‚îÇ -          ‚îÇ -       ‚îÇ -      ‚îÇ -      ‚îÇ -       ‚îÇ -          ‚îÇ
‚îÇ F# 2 ‚îÇ -        ‚îÇ -   ‚îÇ -    ‚îÇ -          ‚îÇ -       ‚îÇ -      ‚îÇ -      ‚îÇ -       ‚îÇ -          ‚îÇ
‚îÇ ...  ‚îÇ ...      ‚îÇ ... ‚îÇ ...  ‚îÇ ...        ‚îÇ ...     ‚îÇ ...    ‚îÇ ...    ‚îÇ ...     ‚îÇ ...        ‚îÇ
‚îÇ F# 9 ‚îÇ -        ‚îÇ -   ‚îÇ -    ‚îÇ -          ‚îÇ -       ‚îÇ -      ‚îÇ -      ‚îÇ -       ‚îÇ -          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è Known Limitations

1. **Finishing Items (F# 1-9)**
   - Currently shown as placeholders
   - Data structure in DO table needs enhancement
   - Can be populated if finishing data available

2. **Reject Column**
   - Always 0 (no reject data in DO table)
   - Can be enhanced with reject tracking

3. **Multiple DO Lines**
   - Currently groups by SO_Num
   - Shows first item details
   - Can be enhanced for multi-item DOs

---

## üîÆ Future Enhancements

### **Short Term:**
- [ ] Populate F# 1-9 with actual finishing data
- [ ] Add reject quantity tracking
- [ ] Handle multiple items per DO
- [ ] Add inline editing for To Bill quantity

### **Long Term:**
- [ ] Add item-level calculations
- [ ] Integrate with inventory system
- [ ] Real-time validation
- [ ] Batch processing support

---

## üìû Support

**API Test:**
```bash
curl -X GET "http://localhost/api/invoices/do-items?do_number=2025-10-00001"
```

**Check Logs:**
```bash
tail -f storage/logs/laravel.log | grep -E "Fetching DO Items|DO Items response"
```

**Browser Console:**
- Open modal ‚Üí F12 ‚Üí Console
- Look for: "üîÑ Fetching DO items for:"
- Check for: "‚úÖ DO items data received:"

---

## ‚úÖ Summary

**Sales Order Items Screen** sekarang:
- ‚úÖ **Fetch real data** dari DO table
- ‚úÖ **Display CPS-compatible** layout
- ‚úÖ **Auto-populate** S/O List dan Item Details
- ‚úÖ **Calculate totals** from database
- ‚úÖ **No migration** required
- ‚úÖ **Style preserved** - no visual changes
- ‚úÖ **Error handling** implemented
- ‚úÖ **Loading indicators** for UX

Modal sekarang berfungsi **persis seperti CPS ERP** dengan data real dari database! üéâ

---

**Last Updated:** October 29, 2025, 23:34 WIB
**Version:** 2.0 - CPS-Compatible with Real Data
